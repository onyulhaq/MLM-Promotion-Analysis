---
title: "Psych 575 Promotion Analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

test test test


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The HR team stored data of promotion cycle last year, which consists of details of all the employees in the company working last year and also if they got promoted or not, but every time this process gets delayed due to so many details available for each employee - it gets difficult to compare and decide.

Data Dictionary
• employeeid: Unique ID for the employee 
• department: Department of employee 
• region: Region of employment (unordered) 
• education: Education Level 
• gender: Gender of Employee 
• recruitmentchannel: Channel of recruitment for employee
• no_ of_ trainings: no of other trainings completed in the previous year on soft skills, technical skills, etc.
• age: Age of Employee
• previous_ year_ rating: Employee Rating for the previous year
• length_ of_ service: Length of service in years
• awards_ won: if awards won during the previous year then 1 else 0
• avg_ training_ score: Average score in current training evaluations
• is_promoted: (Target) Recommended for promotion


```{r Github}
library(usethis)
use_git_config(user.name = "onyulhaq", user.email = "onyulhaq@usc.edu")

```

```{r Library, warning=FALSE}
library(here)  # makes reading data more consistent
library(tidyverse)  # for data manipulation and plotting
library(haven)  # for importing SPSS/SAS/Stata data
library(lme4)  # for multilevel analysis
library(glmmTMB)  # also for multilevel logistic models
library(lmerTest)  # for testing coefficients
library(MuMIn)  # for R^2
library(sjPlot)  # for plotting effects
library(emmeans)  # for marginal means
library(modelsummary)  # for making tables
library(mice) #Missing Data
library(mitml) # missing Data
theme_set(theme_bw())  # Theme; just my personal preference
```


```{r}
#Enter Data
df <- read.csv("C:/Users/Haque/Downloads/MLM Promotion Analysis/MLM Promotion Analysis/employee_promotion.csv", header = T, na.strings = "")

df$is_promoted <- as.factor(df$is_promoted) #Make promotion into factor variable
df$gender <- as.factor(df$gender) #Make gender into factor variable
df$education <- factor(df$education, levels = c("Below Secondary", "Bachelor's", "Master's & above")) #Make gender into factor variable
```

###Missing Data
```{r}
psych::describe(df)

pMiss <- function(x){sum(is.na(x))/length(x)*100} #function to find percentage
apply(df,2,pMiss)
```

```{r}
## Compute the unique response patterns:
pats <- mice::md.pattern(df,
                         rotate.names = TRUE)
pats
```

###Descriptives
There are two level 2 units in this data set: Departments and Region

```{r Clusters size}
#Departments
table(df$department) #List of departments and their sizes
length(table(df$department)) # No. of department clusters
min(table(df$department)) # Size of smallest department cluster size
max(table(df$department)) # Size of largest department cluster size
mean(table(df$department)) #Avg size of cluster
sd(table(df$department))


#Region
table(df$region) #List of region and their sizes
length(table(df$region)) # No. of region clusters
min(table(df$region)) # Size of smallest region cluster size
max(table(df$region)) # Size of largest region cluster size
mean(table(df$region)) # avg size of region
```


```{r Correlations}
#Correlations among continuous predictors
#subset relevant columns
cor.df <- df %>% 
  select(no_of_trainings,age, previous_year_rating, length_of_service, awards_won, avg_training_score)
cor(x = cor.df, use = "complete.obs")

cor(gende)
```

```{r Promoted}
barplot(table(df$is_promoted),
        main = "Promoted Counts")
```


##ICC and Design Effect

```{r}
#Unconditional Model
unconditional <- glmmTMB(is_promoted ~ 1 + (1|region) + (1|department),
                         family = binomial("logit"),
                         data = df)

summary(unconditional)

#Store Variances in object
vc_m0 <- (VarCorr(unconditional))

#ICC Region
icc.region <- vc_m0[[1]]$region[1,1]/(vc_m0[[1]]$region[1,1] + pi^2 / 3)

#ICC Department 
icc.department <- vc_m0[[1]]$department[1,1]/(vc_m0[[1]]$department[1,1] + pi^2 / 3)

#ICC Department + Region

icc.department + icc.region

#Deff Region
deff.region <- (1 - icc.department) + (mean(table(df$region)) - 1) * icc.region

c("ICC region" = icc.region,
  "Deff region" = deff.region)

#Deff Department
deff.department <- (1 - icc.region) + (mean(table(df$department)) - 1) * icc.department

c("ICC department" = icc.department,
  "Deff department" = deff.department)
```


##Power Analysis

### Model Equations
Cross-Classified Model 

within cell Variables: gender, age, previous year rating, length_of_service, awards won, Avg training score, education

Within Cell Lv-1:

$$
  \begin{aligned}
    \text{promotion}_{i(j,k)} & \sim \text{Bernoulli}(\mu_{i(j,k)}) \\
    \eta_{i(j,k)} & = \text{logit}(\mu_{i(j,k)}) \\
    \eta_{i(j,k)} & = \beta_{0(j,k)} + \beta_{1(j,k)} \text{gender}_{i(j,k)} + \beta_{2(j,k)} \text{education}_{i(j,k)} + \beta_{3(j,k)} \text{no_of_trainings}_{i(j,k)} + \beta_{4(j,k)} \text{no_of_trainings}_{i(j,k)} + \beta_{5(j,k)} \text{age}_{i(j,k)} + \beta_{6(j,k)} \text{previous_year_rating}_{i(j,k)} + \beta_{7(j,k)} \text{length_of_service}_{i(j,k)} + \beta_{8(j,k)} \text{awards_on}_{i(j,k)} +  \beta_{9(j,k)} \text{avg_training_score}_{i(j,k)}
  \end{aligned}
$$
Lv-2:

$$
\begin{aligned}
  \beta_{0j} & = \gamma_{00} + u_{0j} + v_{0k}  \\
  \beta_{1j} & = \gamma_{10} + u_{1j} + v_{1k} \\
  \begin{bmatrix}
    u_{0j} \\
    u_{1j}
  \end{bmatrix} & \sim 
  N\left(
    \begin{bmatrix}
      0 \\
      0
    \end{bmatrix}, 
    \begin{bmatrix}
      \tau^2_0 &  \\
      \tau_{01} & \tau^2_{1}
    \end{bmatrix}
  \right)
\end{aligned}
$$




### Models
```{r Gender + Random Slopes}
m0 <- glmmTMB(is_promoted ~ gender + (gender|department) + (gender|region),
            data = df,
            family = binomial("logit"),
            REML = T)
summary(m0)

#Effect size
r.squaredGLMM(m0)
```

```{r Everything}
m1 <- glmmTMB(is_promoted ~ gender + education + age + no_of_trainings + awards_won +
                avg_training_score + length_of_service + previous_year_rating +
                (gender|department) + (gender|region),
            data = df,
            family = binomial("logit"),
            REML = T)
summary(m1)

#Effect size
r.squaredGLMM(m1)
```


```{r}
m2 <- glmmTMB(is_promoted ~ education + age + no_of_trainings + awards_won +
                avg_training_score + length_of_service + previous_year_rating +
                (gender|department) + (gender|region),
            data = df,
            family = binomial("logit"),
            REML = T)
summary(m2)

#Effect size
r.squaredGLMM(m2)
```

### Table of Model Coefficients**
```{r}
msummary(list("Unconditional" = unconditional,
              "Gender + Random Slopes" = m0,
              "Everything" = m1,
              "Everything but Gender" = m2))
```



### Plot of Predictors on Promotion Rates**
```{r}
m1_plots <- plot_model(m1,
    type = "pred",
    show.data = TRUE, jitter = 0.05,
    title = "", dot.size = 0.3
)
m1_plots
```

